<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Configuration - {{ client.business_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .bot-section {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            background: #f8f9fa;
        }
        .subscription-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .status-active {
            color: #28a745;
            font-weight: bold;
        }
        .status-inactive {
            color: #dc3545;
            font-weight: bold;
        }
        .status-expired {
            color: #ffc107;
            font-weight: bold;
        }
        .profile-section {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        .embed-code {
            background: #2d2d2d;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 14px;
        }
        .section-divider {
            border-top: 2px solid #dee2e6;
            margin: 20px 0;
        }
        .bot-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .bot-icon {
            font-size: 24px;
        }
        .number-badge {
            background: #17a2b8;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .no-number-badge {
            background: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .progress-section {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>Configure Bots - {{ client.business_name }}</h1>
                <p class="text-muted">Set up WhatsApp, Voice Call, and Web Chat bots for your client</p>
            </div>
            <a href="/clients" class="btn btn-outline-secondary">‚Üê Back to Clients</a>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-section">
            <h6 class="card-title">Setup Progress</h6>
            <div class="progress mb-2" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
                    <strong>75% Complete</strong>
                </div>
            </div>
            <div class="d-flex justify-content-between text-muted">
                <small>‚úì Add Client</small>
                <small>‚úì Upload Documents</small>
                <small>‚úì Get Phone Number</small>
                <small><strong>Configure Bots</strong></small>
            </div>
        </div>

        <!-- WhatsApp Bot Section -->
        <div class="bot-section">
            <div class="bot-header">
                <span class="bot-icon">üì±</span>
                <h3 class="mb-0">WhatsApp Business Bot</h3>
                {% if phone_number != "Not purchased" %}
                <span class="number-badge">{{ phone_number }}</span>
                {% else %}
                <span class="no-number-badge">No Number</span>
                {% endif %}
            </div>

            <div class="row">
                <div class="col-md-6">
                    <!-- Business Profile -->
                    <div class="profile-section">
                        <h5>üìä Business Profile</h5>
                        <div class="mb-2">
                            <strong>Business Name:</strong> 
                            <span id="whatsapp-business-name">{{ client.business_name }}</span>
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="editField('whatsapp-business-name', 'business_name')">Edit</button>
                        </div>
                        <div class="mb-2">
                            <strong>Business Address:</strong> 
                            <span id="whatsapp-address">Add business address...</span>
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="editField('whatsapp-address', 'address')">Edit</button>
                        </div>
                        <div class="mb-2">
                            <strong>Business Logo:</strong> 
                            <span id="whatsapp-logo">No logo uploaded</span>
                            <button class="btn btn-sm btn-outline-primary ms-2" onclick="uploadLogo()">Upload</button>
                        </div>
                        <small class="text-muted">This information will be shown in WhatsApp Business profile</small>
                    </div>

                    <!-- Current Status -->
                    <div class="mt-3">
                        <h6>Bot Status</h6>
                        <div class="d-flex align-items-center gap-3">
                            <span id="whatsapp-status" class="status-inactive">INACTIVE</span>
                            <div class="btn-group">
                                <button id="whatsapp-activate-btn" class="btn btn-success btn-sm" onclick="toggleBot('whatsapp', 'activate')">Activate</button>
                                <button id="whatsapp-deactivate-btn" class="btn btn-danger btn-sm" onclick="toggleBot('whatsapp', 'deactivate')" style="display: none;">Deactivate</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <!-- Subscription Management -->
                    <div class="profile-section">
                        <h5>üí∞ Subscription</h5>
                        <div class="row mb-2">
                            <div class="col-6">
                                <strong>Start Date:</strong><br>
                                <span id="whatsapp-start-date" class="text-muted">--/--/----</span>
                            </div>
                            <div class="col-6">
                                <strong>Expiry Date:</strong><br>
                                <span id="whatsapp-expiry-date" class="text-muted">--/--/----</span>
                            </div>
                        </div>
                        
                        <div class="section-divider"></div>
                        
                        <h6>Add Subscription Time:</h6>
                        <div class="subscription-buttons">
                            <button class="btn btn-outline-success" onclick="addMonths('whatsapp', 1)">1 Month</button>
                            <button class="btn btn-outline-success" onclick="addMonths('whatsapp', 2)">2 Months</button>
                            <button class="btn btn-outline-success" onclick="addMonths('whatsapp', 3)">3 Months</button>
                            <button class="btn btn-outline-success" onclick="addMonths('whatsapp', 6)">6 Months</button>
                            <button class="btn btn-outline-success" onclick="addMonths('whatsapp', 12)">12 Months</button>
                        </div>
                        <small class="text-muted">First payment sets start date. Renewals extend expiry date.</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voice Call Bot Section -->
        <div class="bot-section">
            <div class="bot-header">
                <span class="bot-icon">üìû</span>
                <h3 class="mb-0">Voice Call Bot</h3>
                {% if phone_number != "Not purchased" %}
                <span class="number-badge">{{ phone_number }}</span>
                {% else %}
                <span class="no-number-badge">No Number</span>
                {% endif %}
            </div>

            <div class="row">
                <div class="col-md-6">
                    <p>Automated voice responses based on your business knowledge base.</p>
                    
                    <!-- Current Status -->
                    <div class="mt-3">
                        <h6>Bot Status</h6>
                        <div class="d-flex align-items-center gap-3">
                            <span id="voice-status" class="status-inactive">INACTIVE</span>
                            <div class="btn-group">
                                <button id="voice-activate-btn" class="btn btn-success btn-sm" onclick="toggleBot('voice', 'activate')">Activate</button>
                                <button id="voice-deactivate-btn" class="btn btn-danger btn-sm" onclick="toggleBot('voice', 'deactivate')" style="display: none;">Deactivate</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <!-- Subscription Management -->
                    <div class="profile-section">
                        <h5>üí∞ Subscription</h5>
                        <div class="row mb-2">
                            <div class="col-6">
                                <strong>Start Date:</strong><br>
                                <span id="voice-start-date" class="text-muted">--/--/----</span>
                            </div>
                            <div class="col-6">
                                <strong>Expiry Date:</strong><br>
                                <span id="voice-expiry-date" class="text-muted">--/--/----</span>
                            </div>
                        </div>
                        
                        <div class="section-divider"></div>
                        
                        <h6>Add Subscription Time:</h6>
                        <div class="subscription-buttons">
                            <button class="btn btn-outline-success" onclick="addMonths('voice', 1)">1 Month</button>
                            <button class="btn btn-outline-success" onclick="addMonths('voice', 2)">2 Months</button>
                            <button class="btn btn-outline-success" onclick="addMonths('voice', 3)">3 Months</button>
                            <button class="btn btn-outline-success" onclick="addMonths('voice', 6)">6 Months</button>
                            <button class="btn btn-outline-success" onclick="addMonths('voice', 12)">12 Months</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Web Chat Bot Section -->
        <div class="bot-section">
            <div class="bot-header">
                <span class="bot-icon">üí¨</span>
                <h3 class="mb-0">Web Chat Bot</h3>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <!-- Chatbot Links -->
                    <div class="profile-section">
                        <h5>üîó Integration</h5>
                        
                        <div class="mb-3">
                            <strong>Chatbot URL:</strong>
                            <div class="input-group mt-1">
                                <input type="text" class="form-control" id="chatbot-url" value="{{ chatbot_url }}" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('chatbot-url')">Copy</button>
                            </div>
                            <small class="text-muted">Share this link with your client</small>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Embed Code:</strong>
                            <div class="embed-code mt-1" id="embed-code-{{ client.id }}">Loading embed code automatically...</div>
                            <button class="btn btn-outline-secondary mt-2" onclick="copyToClipboard('embed-code-{{ client.id }}')" style="display: none;" id="copy-btn-{{ client.id }}">Copy Embed Code</button>
                            <small class="text-muted d-block mt-1">Add this code to your client's website</small>
                        </div>
                    </div>

                    <!-- Current Status -->
                    <div class="mt-3">
                        <h6>Bot Status</h6>
                        <div class="d-flex align-items-center gap-3">
                            <span id="web-status" class="status-inactive">INACTIVE</span>
                            <div class="btn-group">
                                <button id="web-activate-btn" class="btn btn-success btn-sm" onclick="toggleBot('web', 'activate')">Activate</button>
                                <button id="web-deactivate-btn" class="btn btn-danger btn-sm" onclick="toggleBot('web', 'deactivate')" style="display: none;">Deactivate</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <!-- Subscription Management -->
                    <div class="profile-section">
                        <h5>üí∞ Subscription</h5>
                        <div class="row mb-2">
                            <div class="col-6">
                                <strong>Start Date:</strong><br>
                                <span id="web-start-date" class="text-muted">--/--/----</span>
                            </div>
                            <div class="col-6">
                                <strong>Expiry Date:</strong><br>
                                <span id="web-expiry-date" class="text-muted">--/--/----</span>
                            </div>
                        </div>
                        
                        <div class="section-divider"></div>
                        
                        <h6>Add Subscription Time:</h6>
                        <div class="subscription-buttons">
                            <button class="btn btn-outline-success" onclick="addMonths('web', 1)">1 Month</button>
                            <button class="btn btn-outline-success" onclick="addMonths('web', 2)">2 Months</button>
                            <button class="btn btn-outline-success" onclick="addMonths('web', 3)">3 Months</button>
                            <button class="btn btn-outline-success" onclick="addMonths('web', 6)">6 Months</button>
                            <button class="btn btn-outline-success" onclick="addMonths('web', 12)">12 Months</button>
                        </div>
                    </div>

                    <!-- Demo Instructions -->
                    <div class="alert alert-info mt-3">
                        <h6>üöÄ Ready to Test</h6>
                        <small>
                            <strong>Web Chat Bot is ready to use!</strong><br>
                            ‚Ä¢ Copy the embed code to client's website<br>
                            ‚Ä¢ Or share the chatbot URL directly<br>
                            ‚Ä¢ Bot answers based on uploaded PDF knowledge
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation & Actions -->
        <div class="card mt-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="/buy_number" class="btn btn-outline-secondary">‚Üê Previous Step</a>
                    
                    <div class="text-center">
                        <p class="mb-1 text-muted">Ready to complete setup?</p>
                        <form action="/complete_setup" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-success btn-lg">
                                ‚úÖ Finish Setup & Go to Dashboard
                            </button>
                        </form>
                    </div>

                    <a href="/client/{{ client.id }}" class="btn btn-outline-primary">
                        Skip & View Client Page ‚Üí
                    </a>
                </div>
                
                <div class="text-center mt-3">
                    <small class="text-muted">
                        After finishing setup, client will appear in your dashboard where you can manage bots and add more PDFs anytime.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // AUTOMATICALLY GENERATE EMBED CODE ON PAGE LOAD
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üü° Page loaded, generating embed code automatically for client:', '{{ client.id }}');
            generateEmbedCodeAutomatically('{{ client.id }}');
        });

        async function generateEmbedCodeAutomatically(clientId) {
            console.log('üî¥ Auto-generating embed code for client:', clientId);
            
            const embedElement = document.getElementById(`embed-code-${clientId}`);
            const copyBtn = document.getElementById(`copy-btn-${clientId}`);
            
            if (!embedElement) {
                console.error('‚ùå Embed element not found for ID:', `embed-code-${clientId}`);
                return;
            }
            
            if (!clientId) {
                console.error('‚ùå clientId is null or undefined');
                embedElement.textContent = 'Error: Client ID missing';
                return;
            }

            try {
                console.log('üü° Making API request to:', `/api/clients/${clientId}/generate-embed-code`);
                
                const response = await fetch(`/api/clients/${clientId}/generate-embed-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üü¢ API Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('üü¢ API Response data:', result);
                
                if (result.success) {
                    embedElement.textContent = result.embed_code;
                    copyBtn.style.display = 'inline-block';
                    console.log('‚úÖ Embed code generated successfully!');
                } else {
                    embedElement.textContent = 'Error: ' + (result.detail || 'Failed to generate embed code');
                    console.error('‚ùå API Error:', result);
                }
            } catch (error) {
                console.error('‚ùå Fetch Error:', error);
                embedElement.textContent = 'Error: ' + error.message;
            }
        }

        // Edit field functionality
        function editField(fieldId, fieldType) {
            const field = document.getElementById(fieldId);
            const currentValue = field.textContent;
            const fieldName = fieldType === 'business_name' ? 'Business Name' : 
                            fieldType === 'address' ? 'Business Address' : 'Field';
            
            const newValue = prompt(`Edit ${fieldName}:`, currentValue);
            if (newValue !== null && newValue.trim() !== '') {
                field.textContent = newValue;
                updateWhatsAppProfile(fieldType, newValue);
            }
        }

        // Upload logo functionality
        function uploadLogo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('whatsapp-logo').textContent = file.name;
                    console.log('Logo file selected:', file.name);
                    alert('Logo uploaded successfully! (Simulated)');
                }
            };
            input.click();
        }

        // Update WhatsApp profile via API
        async function updateWhatsAppProfile(field, value) {
            try {
                const response = await fetch('/api/whatsapp/update_profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        [field]: value
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    console.log('Profile updated successfully');
                } else {
                    alert('Error updating profile: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Error updating profile. Please try again.');
            }
        }

        // Copy to clipboard functionality
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            let text = element.textContent || element.innerText;
            
            // Clean up text for embed code
            text = text.replace(/\s+/g, ' ').trim();
            
            navigator.clipboard.writeText(text).then(function() {
                alert('‚úÖ Copied to clipboard!');
            }).catch(function(err) {
                console.error('Could not copy text: ', err);
                alert('Failed to copy. Please select and copy manually.');
            });
        }

        // Add months subscription functionality
        async function addMonths(botType, months) {
            if (confirm(`Add ${months} month(s) to ${botType} bot subscription?\n\nFirst payment sets start date to today.\nRenewals extend from current expiry date.`)) {
                try {
                    const response = await fetch('/api/bot/add_months', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            bot_type: botType,
                            months: months
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Update dates from backend response
                        const startDateElement = document.getElementById(`${botType}-start-date`);
                        const expiryDateElement = document.getElementById(`${botType}-expiry-date`);
                        
                        startDateElement.textContent = new Date(result.start_date).toLocaleDateString('en-GB');
                        expiryDateElement.textContent = new Date(result.expiry_date).toLocaleDateString('en-GB');
                        
                        alert(`‚úÖ ${result.message}`);
                        
                        // Enable activation button
                        checkActivationEligibility(botType);
                    } else {
                        alert('‚ùå Error: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error adding months:', error);
                    alert('Error adding months. Please try again.');
                }
            }
        }

        // Toggle bot activation
        async function toggleBot(botType, action) {
            const statusElement = document.getElementById(`${botType}-status`);
            const activateBtn = document.getElementById(`${botType}-activate-btn`);
            const deactivateBtn = document.getElementById(`${botType}-deactivate-btn`);
            const expiryDate = document.getElementById(`${botType}-expiry-date`).textContent;
            
            if (action === 'activate') {
                // Check if subscription is active
                if (expiryDate === '--/--/----') {
                    alert('‚ùå Please add subscription months first!');
                    return;
                }
                
                const expiryDateObj = parseDate(expiryDate);
                if (expiryDateObj < new Date()) {
                    alert('‚ùå Subscription has expired! Please add more months.');
                    return;
                }
            }
            
            try {
                const response = await fetch('/api/bot/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        bot_type: botType,
                        action: action
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    if (action === 'activate') {
                        statusElement.textContent = 'ACTIVE';
                        statusElement.className = 'status-active';
                        activateBtn.style.display = 'none';
                        deactivateBtn.style.display = 'inline-block';
                    } else {
                        statusElement.textContent = 'INACTIVE';
                        statusElement.className = 'status-inactive';
                        activateBtn.style.display = 'inline-block';
                        deactivateBtn.style.display = 'none';
                    }
                    alert(`‚úÖ ${result.message}`);
                } else {
                    alert('‚ùå Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error toggling bot:', error);
                alert('Error toggling bot. Please try again.');
            }
        }

        // Check if bot can be activated
        function checkActivationEligibility(botType) {
            const expiryDate = document.getElementById(`${botType}-expiry-date`).textContent;
            if (expiryDate !== '--/--/----') {
                const expiryDateObj = parseDate(expiryDate);
                if (expiryDateObj > new Date()) {
                    // Enable activate button
                    document.getElementById(`${botType}-activate-btn`).disabled = false;
                }
            }
        }

        // Date formatting utilities
        function formatDate(date) {
            return date.toLocaleDateString('en-GB'); // DD/MM/YYYY format
        }

        function parseDate(dateString) {
            if (dateString === '--/--/----') return new Date();
            const [day, month, year] = dateString.split('/');
            return new Date(year, month - 1, day);
        }

        // Initialize page with existing data
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Bot configuration page loaded for client:', '{{ client.business_name }}');
            
            // Initialize with existing subscription data if any
            {% if subscriptions %}
                {% for bot_type, sub in subscriptions.items() %}
                    {% if sub.start_date %}
                    document.getElementById('{{ bot_type }}-start-date').textContent = new Date('{{ sub.start_date }}').toLocaleDateString('en-GB');
                    {% endif %}
                    {% if sub.expiry_date %}
                    document.getElementById('{{ bot_type }}-expiry-date').textContent = new Date('{{ sub.expiry_date }}').toLocaleDateString('en-GB');
                    {% endif %}
                    {% if sub.status == 'active' %}
                    document.getElementById('{{ bot_type }}-status').textContent = 'ACTIVE';
                    document.getElementById('{{ bot_type }}-status').className = 'status-active';
                    document.getElementById('{{ bot_type }}-activate-btn').style.display = 'none';
                    document.getElementById('{{ bot_type }}-deactivate-btn').style.display = 'inline-block';
                    {% endif %}
                {% endfor %}
            {% endif %}

            // Initialize WhatsApp profile data
            {% if whatsapp_profile %}
                {% if whatsapp_profile.business_name %}
                document.getElementById('whatsapp-business-name').textContent = '{{ whatsapp_profile.business_name }}';
                {% endif %}
                {% if whatsapp_profile.address %}
                document.getElementById('whatsapp-address').textContent = '{{ whatsapp_profile.address }}';
                {% endif %}
            {% endif %}
        });
    </script>
    
</body>
</html>
